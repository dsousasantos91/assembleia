


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > VotacaoService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">br.com.dsousasantos91.assembleia.service</a>
</div>

<h1>Coverage Summary for Class: VotacaoService (br.com.dsousasantos91.assembleia.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VotacaoService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (50/50)
  </span>
</td>
</tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$atDftyhc</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$R900nz76</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$rzxP8jvZ</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$SqBUM4df</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$X94IIIuR</td>
  </tr>
  <tr>
    <td class="name">VotacaoService$MockitoMock$lnsAQxUu$auxiliary$YxZSZeTf</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (50/50)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package br.com.dsousasantos91.assembleia.service;
&nbsp;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Associado;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Sessao;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Votacao;
&nbsp;import br.com.dsousasantos91.assembleia.domain.enumeration.Voto;
&nbsp;import br.com.dsousasantos91.assembleia.exception.GenericBadRequestException;
&nbsp;import br.com.dsousasantos91.assembleia.exception.GenericNotFoundException;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.AssociadoMapper;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.PautaMapper;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.VotacaoMapper;
&nbsp;import br.com.dsousasantos91.assembleia.repository.AssociadoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.repository.SessaoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.repository.VotacaoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.request.VotacaoRequest;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.response.ContagemVotosResponse;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.response.VotacaoResponse;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class VotacaoService {
&nbsp;
&nbsp;    private final VotacaoRepository votacaoRepository;
&nbsp;    private final SessaoRepository sessaoRepository;
&nbsp;    private final AssociadoRepository associadoRepository;
&nbsp;    private final VotacaoMapper votacaoMapper;
&nbsp;    private final AssociadoMapper associadoMapper;
&nbsp;    private final PautaMapper pautaMapper;
&nbsp;    private final ValidarCPFService validarCPFService;
&nbsp;
&nbsp;    public VotacaoResponse votar(VotacaoRequest request) {
<b class="fc">&nbsp;        validarCPFService.validar(request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        log.info(&quot;Encontrando sessão para votação&quot;);</b>
<b class="fc">&nbsp;        Sessao sessao = sessaoRepository.findById(request.getSessaoId())</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Sessão com id %d não existe.&quot;, request.getSessaoId())));</b>
<b class="fc">&nbsp;        log.info(&quot;Sessão ID [{}] encontrata.&quot;, sessao.getId());</b>
<b class="fc">&nbsp;        if (LocalDateTime.now().isAfter(sessao.getDataHoraFim()))</b>
<b class="fc">&nbsp;            throw new GenericBadRequestException(String.format(&quot;Sessão com id %d está encerrada.&quot;, request.getSessaoId()));</b>
<b class="fc">&nbsp;        log.info(&quot;Buscando associado CPF [{}]&quot;, request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        Associado associado = associadoRepository.findByCpf(request.getAssociado().getCpf())</b>
<b class="fc">&nbsp;                .orElse(associadoMapper.toEntity(request.getAssociado()));</b>
<b class="fc">&nbsp;        log.info(&quot;Associado CPF [{}] encontrado com sucesso.&quot;, request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        if (sessaoContemAssociado(sessao, associado))</b>
<b class="fc">&nbsp;            throw new GenericBadRequestException(String.format(&quot;Associado %s não tem permissão para votar na sessão de id %d.&quot;,</b>
<b class="fc">&nbsp;                    associado.getCpf(), request.getSessaoId()));</b>
<b class="fc">&nbsp;        Votacao votacao = Votacao.builder()</b>
<b class="fc">&nbsp;                .sessao(sessao)</b>
<b class="fc">&nbsp;                .associado(associado)</b>
<b class="fc">&nbsp;                .voto(request.getVoto())</b>
<b class="fc">&nbsp;                .build();</b>
<b class="fc">&nbsp;        Votacao votacaoRegistrada = votacaoRepository.save(votacao);</b>
<b class="fc">&nbsp;        log.info(&quot;Votação ID [{}] registrada com sucesso para o associado CPF [{}].&quot;,</b>
<b class="fc">&nbsp;                votacaoRegistrada.getId(), votacaoRegistrada.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        return votacaoMapper.toResponse(votacaoRegistrada);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Page&lt;VotacaoResponse&gt; pesquisar(Pageable pageable) {
<b class="fc">&nbsp;        log.info(&quot;Pesquisando votação.&quot;);</b>
<b class="fc">&nbsp;        return this.votacaoRepository.findAll(pageable).map(votacaoMapper::toResponse);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ContagemVotosResponse contabilizar(Long sessaoId) {
<b class="fc">&nbsp;        log.info(&quot;Realizada contagem dos votos para sessão [{}].&quot;, sessaoId);</b>
<b class="fc">&nbsp;        Sessao sessao = sessaoRepository.findById(sessaoId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Sessão com sessaoId %d não existe.&quot;, sessaoId)));</b>
<b class="fc">&nbsp;        List&lt;Votacao&gt; votacoes = votacaoRepository.findBySessaoId(sessaoId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(&quot;Sessão não encontrada.&quot;));</b>
<b class="fc">&nbsp;        long votosParaNao = votacoes.stream().filter(votacao -&gt; Voto.NAO.equals(votacao.getVoto())).count();</b>
<b class="fc">&nbsp;        long votosParaSim = votacoes.stream().filter(votacao -&gt; Voto.SIM.equals(votacao.getVoto())).count();</b>
<b class="fc">&nbsp;        log.info(&quot;Contagem do votos da sessão [{}] realizada com sucesso.&quot;, sessao.getId());</b>
<b class="fc">&nbsp;        return ContagemVotosResponse.builder()</b>
<b class="fc">&nbsp;                .sessaoId(sessao.getId())</b>
<b class="fc">&nbsp;                .pauta(pautaMapper.toResponse(sessao.getPauta()))</b>
<b class="fc">&nbsp;                .votos(Map.of(Voto.NAO, votosParaNao, Voto.SIM, votosParaSim))</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public VotacaoResponse alterarVoto(Long sessaoId, String cpf) {
<b class="fc">&nbsp;        validarCPFService.validar(cpf);</b>
<b class="fc">&nbsp;        log.info(&quot;Alterando voto do associado CPF [{}].&quot;, cpf);</b>
<b class="fc">&nbsp;        Votacao votacao = votacaoRepository.findBySessaoIdAndAssociadoCpf(sessaoId, cpf)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Associado com CPF %s não encontrado.&quot;, cpf)));</b>
<b class="fc">&nbsp;        Voto novoVoto = Voto.SIM.equals(votacao.getVoto()) ? Voto.NAO : Voto.SIM;</b>
<b class="fc">&nbsp;        votacao.setVoto(novoVoto);</b>
<b class="fc">&nbsp;        Votacao votacaoAlterada = votacaoRepository.save(votacao);</b>
<b class="fc">&nbsp;        log.info(&quot;Alteração de voto do associado CPF [{}] realizada com sucesso.&quot;, cpf);</b>
<b class="fc">&nbsp;        return votacaoMapper.toResponse(votacaoAlterada);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean sessaoContemAssociado(Sessao sessao, Associado associado) {
<b class="fc">&nbsp;        return !sessao.getAssociados().isEmpty() &amp;&amp; !sessao.getAssociados().stream().map(Associado::getCpf).toList().contains(associado.getCpf());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-07-19 20:07</div>
</div>
</body>
</html>
