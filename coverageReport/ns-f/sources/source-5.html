


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > VotoService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">br.com.dsousasantos91.assembleia.service</a>
</div>

<h1>Coverage Summary for Class: VotoService (br.com.dsousasantos91.assembleia.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VotoService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (53/53)
  </span>
</td>
</tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$6sckCWoy</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$AVQT0jap</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$dDKnQVCq</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$DOyv5L6N</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$dTmuZlBa</td>
  </tr>
  <tr>
    <td class="name">VotoService$MockitoMock$szDRLUI3$auxiliary$oWKCNN98</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (53/53)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package br.com.dsousasantos91.assembleia.service;
&nbsp;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Associado;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Sessao;
&nbsp;import br.com.dsousasantos91.assembleia.domain.Voto;
&nbsp;import br.com.dsousasantos91.assembleia.domain.enumeration.VotoEnum;
&nbsp;import br.com.dsousasantos91.assembleia.exception.GenericBadRequestException;
&nbsp;import br.com.dsousasantos91.assembleia.exception.GenericNotFoundException;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.AssociadoMapper;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.PautaMapper;
&nbsp;import br.com.dsousasantos91.assembleia.mapper.VotoMapper;
&nbsp;import br.com.dsousasantos91.assembleia.repository.AssociadoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.repository.SessaoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.repository.VotacaoRepository;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.request.VotoRequest;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.response.ContagemVotosResponse;
&nbsp;import br.com.dsousasantos91.assembleia.service.dto.response.VotoResponse;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;import static java.util.stream.Collectors.toList;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class VotoService {
&nbsp;
&nbsp;    private final VotacaoRepository votacaoRepository;
&nbsp;    private final SessaoRepository sessaoRepository;
&nbsp;    private final AssociadoRepository associadoRepository;
&nbsp;    private final VotoMapper votoMapper;
&nbsp;    private final AssociadoMapper associadoMapper;
&nbsp;    private final PautaMapper pautaMapper;
&nbsp;    private final ValidarCPFService validarCPFService;
&nbsp;
&nbsp;    public VotoResponse votar(VotoRequest request) {
<b class="fc">&nbsp;        validarCPFService.validar(request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        log.info(&quot;Encontrando sessão para votação&quot;);</b>
<b class="fc">&nbsp;        Sessao sessao = sessaoRepository.findById(request.getSessaoId())</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Sessão com id %d não existe.&quot;, request.getSessaoId())));</b>
<b class="fc">&nbsp;        log.info(&quot;Sessão ID [{}] encontrata.&quot;, sessao.getId());</b>
<b class="fc">&nbsp;        if (LocalDateTime.now().isAfter(sessao.getDataHoraFim()))</b>
<b class="fc">&nbsp;            throw new GenericBadRequestException(String.format(&quot;Sessão com id %d está encerrada.&quot;, request.getSessaoId()));</b>
<b class="fc">&nbsp;        log.info(&quot;Buscando associado CPF [{}]&quot;, request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        Associado associado = associadoRepository.findByCpf(request.getAssociado().getCpf())</b>
<b class="fc">&nbsp;                .orElse(associadoMapper.toEntity(request.getAssociado()));</b>
<b class="fc">&nbsp;        log.info(&quot;Associado CPF [{}] encontrado com sucesso.&quot;, request.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        if (sessaoContemAssociado(sessao, associado))</b>
<b class="fc">&nbsp;            throw new GenericBadRequestException(String.format(&quot;Associado %s não tem permissão para votar na sessão de id %d.&quot;,</b>
<b class="fc">&nbsp;                    associado.getCpf(), request.getSessaoId()));</b>
<b class="fc">&nbsp;        Voto voto = Voto.builder()</b>
<b class="fc">&nbsp;                .sessao(sessao)</b>
<b class="fc">&nbsp;                .associado(associado)</b>
<b class="fc">&nbsp;                .voto(request.getVoto())</b>
<b class="fc">&nbsp;                .build();</b>
<b class="fc">&nbsp;        Voto votoRegistrado = votacaoRepository.save(voto);</b>
<b class="fc">&nbsp;        log.info(&quot;Votação ID [{}] registrada com sucesso para o associado CPF [{}].&quot;,</b>
<b class="fc">&nbsp;                votoRegistrado.getId(), votoRegistrado.getAssociado().getCpf());</b>
<b class="fc">&nbsp;        return votoMapper.toResponse(votoRegistrado);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Page&lt;VotoResponse&gt; pesquisar(Pageable pageable) {
<b class="fc">&nbsp;        log.info(&quot;Pesquisando votação.&quot;);</b>
<b class="fc">&nbsp;        return this.votacaoRepository.findAll(pageable).map(votoMapper::toResponse);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ContagemVotosResponse contabilizar(Long sessaoId) {
<b class="fc">&nbsp;        log.info(&quot;Realizada contagem dos votos para sessão [{}].&quot;, sessaoId);</b>
<b class="fc">&nbsp;        Sessao sessao = sessaoRepository.findById(sessaoId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Sessão com sessaoId %d não existe.&quot;, sessaoId)));</b>
<b class="fc">&nbsp;        List&lt;Voto&gt; votacoes = votacaoRepository.findBySessaoId(sessaoId)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(&quot;Sessão não encontrada.&quot;));</b>
<b class="fc">&nbsp;        long votosParaNao = votacoes.stream().filter(votacao -&gt; VotoEnum.NAO.equals(votacao.getVoto())).count();</b>
<b class="fc">&nbsp;        long votosParaSim = votacoes.stream().filter(votacao -&gt; VotoEnum.SIM.equals(votacao.getVoto())).count();</b>
<b class="fc">&nbsp;        log.info(&quot;Contagem do votos da sessão [{}] realizada com sucesso.&quot;, sessao.getId());</b>
<b class="fc">&nbsp;        Map&lt;VotoEnum, Long&gt; votos = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        votos.put(VotoEnum.NAO, votosParaNao);</b>
<b class="fc">&nbsp;        votos.put(VotoEnum.SIM, votosParaSim);</b>
<b class="fc">&nbsp;        return ContagemVotosResponse.builder()</b>
<b class="fc">&nbsp;                .sessaoId(sessao.getId())</b>
<b class="fc">&nbsp;                .pauta(pautaMapper.toResponse(sessao.getPauta()))</b>
<b class="fc">&nbsp;                .votos(votos)</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public VotoResponse alterar(Long sessaoId, String cpf) {
<b class="fc">&nbsp;        validarCPFService.validar(cpf);</b>
<b class="fc">&nbsp;        log.info(&quot;Alterando voto do associado CPF [{}].&quot;, cpf);</b>
<b class="fc">&nbsp;        Voto voto = votacaoRepository.findBySessaoIdAndAssociadoCpf(sessaoId, cpf)</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new GenericNotFoundException(String.format(&quot;Associado com CPF %s não encontrado.&quot;, cpf)));</b>
<b class="fc">&nbsp;        VotoEnum novoVoto = VotoEnum.SIM.equals(voto.getVoto()) ? VotoEnum.NAO : VotoEnum.SIM;</b>
<b class="fc">&nbsp;        voto.setVoto(novoVoto);</b>
<b class="fc">&nbsp;        Voto votoAlterado = votacaoRepository.save(voto);</b>
<b class="fc">&nbsp;        log.info(&quot;Alteração de voto do associado CPF [{}] realizada com sucesso.&quot;, cpf);</b>
<b class="fc">&nbsp;        return votoMapper.toResponse(votoAlterado);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean sessaoContemAssociado(Sessao sessao, Associado associado) {
<b class="fc">&nbsp;        return !sessao.getAssociados().isEmpty() &amp;&amp; !sessao.getAssociados().stream().map(Associado::getCpf).collect(toList()).contains(associado.getCpf());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-07-20 13:48</div>
</div>
</body>
</html>
